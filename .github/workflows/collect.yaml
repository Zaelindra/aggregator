name: Collect
on:
  # æ¯å‘¨ä¸€ 00:00 æ‰§è¡Œä¸€æ¬¡
  schedule:
    - cron: "0 0,8,16 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.repository }}
  cancel-in-progress: true

env:
  # æ—¶åŒºè®¾ç½®
  TZ: Asia/Shanghai

  # GitHubè®¿é—®ä»¤ç‰Œ
  GIST_PAT: ${{ secrets.GIST_PAT }}

  # GitHubç”¨æˆ·åå’Œgist IDï¼Œç”¨"/"åˆ†éš”
  GIST_LINK: ${{ secrets.GIST_LINK }}

  # è‡ªå®šä¹‰æœºåœºåˆ—è¡¨çš„URL
  CUSTOMIZE_LINK: ${{ secrets.CUSTOMIZE_LINK }}

  # æ˜¯å¦å¯ç”¨ç‰¹æ®Šåè®®ï¼Œå¦‚vless hysteria2å’Œhysteria
  ENABLE_SPECIAL_PROTOCOLS: ${{ vars.ENABLE_SPECIAL_PROTOCOLS }}

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Prepare
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"
          cache: "pip"

      - name: Install
        run: pip3 install -r requirements.txt

      - name: Check
        run: |
          if [ -z "$GIST_PAT" ]; then
              echo "Error: environment 'GIST_PAT' cannot be empty"
              exit 1
          fi

          if [ -z "$GIST_LINK" ]; then
              echo "Error: environment 'GIST_LINK' cannot be empty"
              exit 1
          fi

          LINK_PARTS=$(echo "$GIST_LINK" | awk -F'/' 'NF==2 && $1!="" && $2!=""')
          if [ -z "$LINK_PARTS" ]; then
              echo "Error: environment 'GIST_LINK' is not valid, should be 'username/gist_id' format"
              exit 1
          fi

      - name: Collect
        run: python -u subscribe/collect.py --all --overwrite --skip > collect_output.log

      - name: Parse Proxy Count
        id: parse_proxy_count
        run: |
          # ä»æ—¥å¿—æ–‡ä»¶ä¸­æå–ä»£ç†æ•°é‡
          proxy_count=$(grep -oP 'found \K\d+(?= proxies)' collect_output.log)
          echo "ä»£ç†æ•°é‡: $proxy_count"

          # å°†ä»£ç†æ•°é‡å’Œæ—¶é—´æˆ³è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œä»¥ä¾¿åœ¨åç»­æ­¥éª¤ä¸­è®¿é—®
          echo "PROXY_COUNT=$proxy_count" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date)" >> $GITHUB_ENV

      - name: Send Proxy Update with Image to Telegram
        if: success()
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          # è·å–éšæœºå›¾ç‰‡ URL
          image_url=$(curl -s https://api.miaomc.cn/image/get | jq -r .url)
          
          # æ„å»ºæ¨é€æ¶ˆæ¯
          message="
          æ›´æ–°æˆåŠŸï¼
          ğŸš€- èŠ‚ç‚¹æ•°é‡ï¼š${{ env.PROXY_COUNT }} 
          - æ›´æ–°æ—¶é—´ï¼š${{ env.TIMESTAMP }} 
          - æ›´æ–°çŠ¶æ€ï¼š*æˆåŠŸ* âœ…"
          
          # æ£€æŸ¥å›¾ç‰‡ URL æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæœ‰å›¾ç‰‡åˆ™å‘é€å›¾æ–‡æ¨é€ï¼Œå¦åˆ™å‘é€çº¯æ–‡æœ¬
          if [[ -z "$image_url" ]]; then
            echo "å›¾ç‰‡ URL ä¸ºç©ºï¼Œå‘é€çº¯æ–‡æœ¬æ¶ˆæ¯..."
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
              -d chat_id="$CHAT_ID" \
              -d text="$message" \
              -d parse_mode="Markdown"
          else
            echo "è·å–çš„å›¾ç‰‡ URL: $image_urlï¼Œå‘é€å›¾æ–‡æ¶ˆæ¯..."
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendPhoto" \
              -F chat_id="$CHAT_ID" \
              -F photo="$image_url" \
              -F caption="$message" \
              -F parse_mode="Markdown"
          fi

